<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×œ×•×— ×˜×”×¨×”</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Assistant:wght@500;600;700;800&family=Heebo:wght@500;700;800;900&family=Rubik:wght@500;700;800&display=swap");
    :root {
      --bg:#fff4fa;
      --bg-2:#ffeaf6;
      --card:#ffffffde;
      --text:#2a2042;
      --muted:#6f628f;
      --line:#e8d8eb;
      --accent:#c64d88;
      --shadow:0 10px 30px rgba(160,74,126,.15);
      --pink:#ffddeb;
      --green:#e9f9ee;
      --warn:#fff7d7;
    }
    body.dark{--bg:#1e1527;--bg-2:#2d1c36;--card:#2c2036e6;--text:#f6eaff;--muted:#ceb5da;--line:#4d395b;--accent:#e67db1;--shadow:0 12px 30px rgba(0,0,0,.35);--pink:#473040;--green:#30483a;--warn:#4b432d}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Assistant","Rubik",sans-serif;font-weight:600;letter-spacing:.01em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;color:var(--text);background:linear-gradient(160deg,var(--bg),var(--bg-2));min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(120deg,transparent 0 22px,rgba(230,102,173,.08) 22px 24px,transparent 24px 46px);animation:bgMove 14s linear infinite;opacity:.8;z-index:-1}
    .hidden{display:none!important}
    .topbar{position:sticky;top:0;z-index:30;padding:10px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:start;background:var(--card);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .brand{display:flex;align-items:center;gap:12px;justify-self:center;background:#fff;border:1px solid var(--line);border-radius:18px;padding:8px 12px;width:min(620px,100%)}.logo{width:120px;height:74px;border-radius:12px;object-fit:cover}.title{font-family:"Heebo","Assistant",sans-serif;font-size:1.65rem;font-weight:900}.subtitle{font-size:.92rem;color:var(--muted);font-weight:700}.brand-symbol{font-size:1.4rem;color:#8a5a3f}
    .menu-btn{justify-self:end}
    .today-panel{justify-self:start;min-width:240px;padding:10px 12px;border-radius:16px;background:linear-gradient(160deg,#fff,#ffeefe);border:1px solid var(--line);box-shadow:var(--shadow)}
    .today-head{display:flex;justify-content:space-between;font-weight:800}.clock{font-size:1.25rem;font-weight:800;color:var(--accent)}.small{font-size:.82rem;color:var(--muted)}
    .chip-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{padding:4px 10px;border-radius:999px;font-size:.78rem;border:1px solid var(--line);background:#fff}
    .container{max-width:1100px;margin:14px auto;padding:0 14px 30px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .controls{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px}
    .monthTitle{font-weight:800;min-width:260px;text-align:center;padding:8px;border-radius:12px;background:#ffffff88;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#ffffffcc;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer;color:var(--text)}
    .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
    .calendar{padding:12px}
    .dow,.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow div{text-align:center;padding:10px 6px;border:1px solid var(--line);border-radius:10px;font-size:.9rem;color:var(--muted);font-weight:800;white-space:nowrap;overflow:visible;line-height:1.2}
    .cell{min-height:120px;padding:8px;border-radius:14px;border:1px solid var(--line);background:#fffefe;cursor:pointer;transition:.2s;position:relative}
    .cell:hover{transform:translateY(-2px)}
    .muted{opacity:.45}
    .today{outline:2px solid var(--accent)}
    .today .greg,.today .hebrew{font-weight:900;color:#9a205f}
    .phase-period{background:var(--pink)}
    .phase-wait{background:#fff}
    .phase-clean{background:var(--green)}
    .phase-mikveh{background:#d7f3ff}
    .phase-prisha{background:var(--warn)}
    .greg{font-size:1.2rem;font-weight:800}
    .hebrew{font-size:.8rem;color:var(--muted)}
    .sunset{font-size:.72rem;color:#9f4f73;margin-top:5px}
    .badge{display:inline-block;margin-top:5px;padding:3px 8px;border-radius:999px;font-size:.72rem;background:#fff;border:1px solid var(--line)}
    .badge.period{background:#ffd6e8}.badge.hefsek{background:#e5ffe9}.badge.mikveh{background:#c7efff}.badge.prisha{background:#fff2b8}.badge.orzarua{background:#ffeedf}.badge.hefsekReady{background:#dcffe8}
    .day-halves{display:grid;grid-template-columns:1fr 1fr;position:relative;border-radius:10px;overflow:hidden;border:1px solid #eaddea;margin-bottom:4px}
    .day-halves::before{content:"";position:absolute;top:0;bottom:0;left:50%;width:1px;background:#d7c6de}
    .half{padding:2px 4px;min-height:18px;font-size:.62rem;display:flex;gap:3px;align-items:center;justify-content:center}
    .half-night{background:rgba(142,119,161,.08)}
    .half-night.mikveh-night{background:#b98ce4;color:#fff;font-weight:800}
    .half-day{background:rgba(255,202,94,.12)}
    .drawer-backdrop{position:fixed;inset:0;background:#0006;z-index:40}
    .drawer{position:fixed;top:0;right:0;bottom:0;width:min(390px,92vw);z-index:41;background:linear-gradient(180deg,#fff,#ffeef8);border-left:1px solid var(--line);padding:14px;display:grid;gap:10px;align-content:start;box-shadow:-12px 0 30px rgba(0,0,0,.15)}
    body.dark .drawer{background:linear-gradient(180deg,#31253a,#281d30)}
    .switch{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--line);background:#ffffffcc;gap:8px}
    .switch input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:46px;height:26px;border-radius:999px;background:#b8bfd3;position:relative;cursor:pointer;transition:background .2s ease}
    .switch input[type="checkbox"]::after{content:"";position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform .2s ease}
    .switch input[type="checkbox"]:checked{background:#2f8cff}
    .switch input[type="checkbox"]:checked::after{transform:translateX(-20px)}
    .drawer-head{display:flex;justify-content:space-between;align-items:center}
    .drawer-close{margin-inline-start:auto;font-size:.85rem;padding:6px 9px;min-width:unset}
    .modal-overlay{position:fixed;inset:0;background:#0004;display:grid;place-items:center;z-index:60;padding:12px}
    .modal{width:min(560px,95vw);padding:14px}
    .modal-head{display:flex;justify-content:space-between;align-items:flex-start}
    .modal-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .auth-form{display:grid;gap:8px;margin-top:10px}input,select{padding:8px;border-radius:10px;border:1px solid var(--line)}
    .toast{position:fixed;left:16px;bottom:16px;padding:10px;border-radius:12px;background:var(--card);border:1px solid var(--line)}
    .today-banner{margin-top:8px;padding:8px 10px;border-radius:12px;background:linear-gradient(120deg,#ffe0ec,#ffd0e2);border:1px solid #f3b2cd;color:#931d53;font-weight:800;font-size:.9rem;box-shadow:var(--shadow)}
    body.dark .today-banner{background:linear-gradient(120deg,#5b3047,#4c2038);color:#ffd7e8;border-color:#7f4964}
    @keyframes bgMove{from{transform:translateX(0)}to{transform:translateX(90px)}}
    @media(max-width:1024px){.logo{width:90px;height:62px}.topbar{padding:10px 12px}.cell{min-height:105px}.drawer{width:min(420px,94vw)}.brand{width:100%}}
    @media(max-width:900px){.topbar{grid-template-columns:1fr auto;}.today-panel{grid-column:1/-1;justify-self:stretch}.brand{justify-self:start}.controls{flex-wrap:wrap}.monthTitle{min-width:220px}}
    @media(max-width:720px){.container{padding:0 10px 22px}.calendar,.controls{padding:10px}.dow,.grid{gap:6px}.cell{min-height:88px;padding:6px}.greg{font-size:1rem}.hebrew{font-size:.74rem}.sunset{font-size:.68rem}.menu-btn{padding:10px 14px;font-size:1rem}.logo{width:56px;height:56px}.title{font-size:1.1rem}.subtitle{font-size:.74rem}}
  </style>
</head>
<body>
<header class="topbar">
  <button id="menuBtn" class="btn menu-btn">â˜°</button>
  <div class="brand">
    <img class="logo" src="1.png" alt="×œ×•×’×•" />
    <div><div class="title">×œ×•×— ×˜×”×¨×” <span class="brand-symbol">âœ¡</span></div><div class="subtitle">× ×™×”×•×œ ××—×–×•×¨, ×¤×¨×™×©×” ×•×”×¤×¡×§ ×˜×”×¨×”</div></div>
  </div>
  <section class="today-panel" id="todayPanel">
    <div class="today-head"><span>×”×™×•×</span><span id="clock" class="clock">--:--:--</span></div>
    <div class="small" id="todayDate"></div>
    <div class="small" id="todaySunset">×©×§×™×¢×”: ×˜×•×¢×Ÿ ×œ×¤×™ ××™×§×•×â€¦</div>
    <div id="todayBanner" class="today-banner hidden"></div>
    <div id="todayChips" class="chip-wrap"></div>
  </section>
</header>
<main class="container">
  <section class="controls card">
    <button id="prevMonth" class="btn">â—€ ×—×•×“×© ×§×•×“×</button>
    <div id="monthTitle" class="monthTitle"></div>
    <button id="nextMonth" class="btn">×—×•×“×© ×”×‘× â–¶</button>
  </section>
  <section class="calendar card">
    <div class="dow"><div>×™×•× ××³</div><div>×™×•× ×‘×³</div><div>×™×•× ×’×³</div><div>×™×•× ×“×³</div><div>×™×•× ×”×³</div><div>×™×•× ×•×³</div><div>×©×‘×ª</div></div>
    <div id="grid" class="grid"></div>
  </section>
</main>
<footer style="text-align:center;padding:22px;color:var(--muted);font-weight:700">× ×‘× ×” ×¢×œ ×™×“×™ ×™×³.×–×³.××³. ××ª×¨×™× ×œ×¤×¨×˜×™× ×”×™×›× ×¡×• ×œ<a href="https://hidon1.github.io/a/" target="_blank" rel="noopener" style="color:var(--accent);font-weight:800">×§×™×©×•×¨</a>.</footer>
<div id="drawerBackdrop" class="drawer-backdrop hidden"></div>
<aside id="drawer" class="drawer hidden">
  <div class="drawer-head"><h3>×ª×¤×¨×™×˜ ×—×›×</h3><button id="closeDrawer" class="btn drawer-close">âœ•</button></div>
  <div class="switch"><span>××¦×‘ ×›×”×”</span><input id="darkToggle" type="checkbox"></div>
  <div class="switch"><span>×™×•× ×¤×¨×™×©×” 31</span><input id="day31Toggle" type="checkbox"></div>
  <div class="switch"><span>××•×¤×Ÿ ×™×•× 30</span><select id="day30Mode"><option value="ona">×¨×§ ×¢×•× ×ª ×¨××™×™×”</option><option value="full">×›×œ ×”×™×•× (×™×•×+×œ×™×œ×”)</option></select></div>
  <div class="switch"><span>××•×¤×Ÿ ×™×•× 31</span><select id="day31Mode"><option value="ona">×¨×§ ×¢×•× ×ª ×¨××™×™×”</option><option value="full">×›×œ ×”×™×•× (×™×•×+×œ×™×œ×”)</option></select></div>
  <div class="switch"><span>×ª×–×›×•×¨×ª ×œ×”×¤×¡×§ ×˜×”×¨×”</span><input id="reminderToggle" type="checkbox"></div>
  <div class="switch"><span>×ª×–×›×•×¨×ª ×œ×™××™ ×¤×’×™×©×”</span><input id="meetingToggle" type="checkbox"></div>
  <div class="switch"><span>×©×¢×ª ×ª×–×›×•×¨×ª</span><input id="reminderTime" type="time" value="15:00"></div>
  <div class="switch"><span>×©×§×™×¢×” ×œ×¤×™</span><select id="sunsetMode"><option value="location">××§×•× × ×•×›×—×™ (××©×ª× ×”)</option><option value="city">×¢×™×¨ ×§×‘×•×¢×”</option></select></div>
  <div class="switch"><span>×¢×™×¨ ×§×‘×•×¢×”</span><select id="sunsetCity"><option value="Jerusalem">×™×¨×•×©×œ×™×</option><option value="Tel Aviv">×ª×œ ××‘×™×‘</option><option value="Haifa">×—×™×¤×”</option><option value="Beersheba">×‘××¨ ×©×‘×¢</option></select></div>
  <div class="switch"><span>×× ×”×’</span><select id="minhagSelect"><option value="sephardi">×¡×¤×¨×“×™×</option><option value="ashkenazi">××©×›× ×–×™×</option></select></div>
  <button id="openAuthFromMenu" class="btn btn-primary">×”×ª×—×‘×¨×•×ª / ×”×¨×©××”</button>
  <div id="authState" class="small">×œ× ××—×•×‘×¨</div>
</aside>
<div id="modalOverlay" class="modal-overlay hidden"><div class="modal card"><div class="modal-head"><div><div id="modalDateTitle"></div><div id="modalDateSub" class="small"></div></div><button id="modalClose" class="btn">âœ•</button></div><div class="modal-actions"><button id="btnEventA" class="btn">×”×¤×¡×§ ×˜×”×¨×”</button><button id="btnEventB" class="btn">×ª×—×™×œ×ª ××—×–×•×¨</button><button id="btnClear" class="btn">× ×§×”</button></div></div></div>
<div id="onaOverlay" class="modal-overlay hidden"><div class="modal card" style="max-width:340px"><div>×‘×—×¨×™ ×¢×•× ×”:</div><div class="modal-actions"><button id="chooseDay" class="btn">â˜€ï¸ ×™×•×</button><button id="chooseNight" class="btn">ğŸŒ™ ×œ×™×œ×”</button><button id="onaCancel" class="btn">×‘×™×˜×•×œ</button></div></div></div>
<div id="authOverlay" class="modal-overlay hidden"><div class="modal card" style="max-width:420px"><div class="modal-head"><div><div id="authTitle">×”×ª×—×‘×¨×•×ª</div><div id="authSub" class="small"></div></div><button id="authClose" class="btn">âœ•</button></div><form class="auth-form"><input id="email" type="email" placeholder="××™××™×™×œ" required><input id="password" type="password" placeholder="×¡×™×¡××”" required><button id="authActionBtn" type="button" class="btn btn-primary">×”×ª×—×‘×¨×•×ª</button><button id="signOutBtn" type="button" class="btn">×”×ª× ×ª×§×•×ª</button></form><div class="small"><span id="authSwitchText"></span> <button id="authSwitchBtn" class="btn">×œ×—×¥ ×›××Ÿ</button></div><div id="authMsg" class="small"></div></div></div>
<div id="toast" class="toast hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDiN-q4MWmKLqMpjtbevW5sTGXgoFOyQ94",authDomain:"luach-48111.firebaseapp.com",projectId:"luach-48111",storageBucket:"luach-48111.firebasestorage.app",messagingSenderId:"418216623160",appId:"1:418216623160:web:56ebe2830458d6b12f3acd",measurementId:"G-BJ2LVM6WR6"};
const app=initializeApp(firebaseConfig); if(await isSupported()) getAnalytics(app); const auth=getAuth(app); const db=getFirestore(app);

const el=id=>document.getElementById(id);
const grid=el("grid"),monthTitle=el("monthTitle"),authState=el("authState"),toast=el("toast");
const today=startOfDay(new Date()); let view=new Date(today.getFullYear(),today.getMonth(),1);
const STORAGE_KEY="calendar_events_v7",PREFS_KEY="calendar_prefs_v6",AUTH_PROMPT_KEY="auth_prompt_seen_v2",REMINDER_FIRE_KEY="hefsek_reminder_fired_v1",SUNSET_CITY_CACHE_KEY="sunset_city_cache_v1";
let dayEvents=loadLocalEvents(),currentUid=null,authMode="signin",clockTimer=null,sunsetCache=loadSunsetCache(),locationPromise=null,lastCoords=null,reminderTimer=null;
const CITY_COORDS={"Jerusalem":{latitude:31.7683,longitude:35.2137,label:"×™×¨×•×©×œ×™×"},"Tel Aviv":{latitude:32.0853,longitude:34.7818,label:"×ª×œ ××‘×™×‘"},"Haifa":{latitude:32.794,longitude:34.9896,label:"×—×™×¤×”"},"Beersheba":{latitude:31.252,longitude:34.7915,label:"×‘××¨ ×©×‘×¢"}};

function pad2(n){return String(n).padStart(2,"0")} function ymd(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function startOfDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())} function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return startOfDay(x)}
function numberToHebrewDay(n){const ones=["","×","×‘","×’","×“","×”","×•","×–","×—","×˜"],tens=["","×™","×›","×œ"];if(n===15)return"×˜×´×•";if(n===16)return"×˜×´×–";if(n<10)return `${ones[n]}×³`;if(n%10===0)return `${tens[n/10]}×³`;return `${tens[Math.floor(n/10)]}×´${ones[n%10]}`}
function getHebrewDateDisplay(d){const parts=new Intl.DateTimeFormat("he-u-ca-hebrew",{day:"numeric",month:"long"}).formatToParts(d);const day=Number(parts.find(p=>p.type==="day")?.value||1);const month=parts.find(p=>p.type==="month")?.value||"";return `${numberToHebrewDay(day)} ${month}`}
const markerIcon=o=>o==="day"?"â˜€ï¸":"ğŸŒ™"; const markerLabel=(b,o)=>o?`${b} ${markerIcon(o)}`:b;
const normalizeDay=v=>!v?{markers:[]}:Array.isArray(v.markers)?v:v.type?{markers:[v]}:{markers:[]};
function loadLocalEvents(){try{return new Map(Object.entries(JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")));}catch{return new Map();}}
function getPrefs(){try{return JSON.parse(localStorage.getItem(PREFS_KEY)||"{}");}catch{return {};}}
function exportEvents(){const o={};for(const[k,v]of dayEvents.entries())o[k]=normalizeDay(v);return o;}
function addMarker(dateKey,marker,{replaceType=false}={}){const day=normalizeDay(dayEvents.get(dateKey));if(replaceType)day.markers=day.markers.filter(m=>m.type!==marker.type);if(!day.markers.some(m=>m.type===marker.type&&m.ona===marker.ona&&m.source===marker.source))day.markers.push(marker);dayEvents.set(dateKey,day)}
function clearDerived(){for(const [k,v]of dayEvents.entries()){const keep=normalizeDay(v).markers.filter(m=>!m.source);keep.length?dayEvents.set(k,{markers:keep}):dayEvents.delete(k)}}
async function persistAll(){const events=exportEvents();localStorage.setItem(STORAGE_KEY,JSON.stringify(events));if(currentUid)await setDoc(doc(db,"users",currentUid),{events,prefs:getPrefs(),updatedAt:Date.now()},{merge:true})}
function setPrefs(next){localStorage.setItem(PREFS_KEY,JSON.stringify({...getPrefs(),...next}));persistAll();}
function loadSunsetCache(){try{return JSON.parse(localStorage.getItem(SUNSET_CITY_CACHE_KEY)||"{}");}catch{return {};}}
function saveSunsetCache(){localStorage.setItem(SUNSET_CITY_CACHE_KEY,JSON.stringify(sunsetCache));}

async function loadRemoteEvents(uid){const snap=await getDoc(doc(db,"users",uid));if(!snap.exists())return;const data=snap.data();if(data.events)dayEvents=new Map(Object.entries(data.events));if(data.prefs)localStorage.setItem(PREFS_KEY,JSON.stringify({...getPrefs(),...data.prefs}));}
function showToast(msg){toast.textContent=msg;toast.classList.remove("hidden");setTimeout(()=>toast.classList.add("hidden"),1600)}

function minhagDays(){const m=getPrefs().minhag||"sephardi";return m==="ashkenazi"?5:4}
function canSetHefsek(d){const periods=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(m=>m.type==="period").map(()=>new Date(k))).sort((a,b)=>a-b);const last=periods.filter(p=>p<=d).at(-1);if(!last)return false;return startOfDay(d)>=addDays(last,minhagDays()-1)}
function getPrishaOnotForMode(baseOna,mode){return mode==="full"?["night","day"]:[baseOna];}
function addPrishaMarkers(date,onot,label,source){for(const ona of onot){addMarker(ymd(date),{type:"prisha",label:markerLabel(label,ona),ona,source});}}
function calculateKavuah(patterns){
  const byGap=new Map(),byHebrew=new Map();
  if(patterns.length<3) return {byGap,byHebrew};
  for(let i=0;i<=patterns.length-3;i++){
    const a=patterns[i],b=patterns[i+1],c=patterns[i+2];
    const gap1=Math.round((b.date-a.date)/86400000),gap2=Math.round((c.date-b.date)/86400000);
    if(gap1===gap2){const key=`gap-${gap1}-${c.ona}`;if(!byGap.has(key))byGap.set(key,{gap:gap1,ona:c.ona,start:c.date});}
    const h1=getHebrewDateParts(a.date),h2=getHebrewDateParts(b.date),h3=getHebrewDateParts(c.date);
    const d1=h1.day,d2=h2.day,d3=h3.day;
    if((d1===d2&&d2===d3)||((d2-d1+30)%30===1&&(d3-d2+30)%30===1)){
      const key=`heb-${d3}-${c.ona}-${h3.month}`;
      if(!byHebrew.has(key))byHebrew.set(key,{day:d3,ona:c.ona,start:c.date,increment:(d1===d2&&d2===d3)?0:1});
    }
  }
  return {byGap,byHebrew};
}
function getHebrewDateParts(d){
  const parts=new Intl.DateTimeFormat("he-u-ca-hebrew",{day:"numeric",month:"long"}).formatToParts(d);
  return {day:Number(parts.find(p=>p.type==="day")?.value||1),month:parts.find(p=>p.type==="month")?.value||""};
}
function hasKavuahForPeriod(period,kavuah){
  for(const v of kavuah.byGap.values()) if(v.ona===period.ona && period.date>=v.start) return true;
  for(const v of kavuah.byHebrew.values()) if(v.ona===period.ona && period.date>=v.start) return true;
  return false;
}
function recalcDerived(){
  clearDerived();
  const periods=[],hefseks=[];
  for(const [k,v] of dayEvents.entries()) for(const m of normalizeDay(v).markers){if(m.type==="period")periods.push({date:new Date(k),ona:m.ona||"day"}); if(m.type==="hefsek")hefseks.push(new Date(k));}
  periods.sort((a,b)=>a.date-b.date); hefseks.sort((a,b)=>a-b);
  const prefs=getPrefs();
  const day30Mode=prefs.day30Mode||"ona",day31Mode=prefs.day31Mode||"ona";
  const kavuah=calculateKavuah(periods);
  for(const p of periods){
    const d30=addDays(p.date,29);
    if(!hasKavuahForPeriod(p,kavuah)){addPrishaMarkers(d30,getPrishaOnotForMode(p.ona,day30Mode),"×™×•× ×¤×¨×™×©×”","auto-30");}
    const ozDate=p.ona==="day"?d30:addDays(d30,-1); addMarker(ymd(ozDate),{type:"orzarua",label:markerLabel("××•×¨ ×–×¨×•×¢",p.ona==="day"?"night":"day"),ona:p.ona==="day"?"night":"day",source:"auto-oz"});
    if(prefs.day31){const d31=addDays(p.date,30);addPrishaMarkers(d31,getPrishaOnotForMode(p.ona,day31Mode),"×™×•× ×¤×¨×™×©×” 31","auto-31");}
    const ready=addDays(p.date,minhagDays()-1); addMarker(ymd(ready),{type:"hefsekReady",label:"××¤×©×¨ ×”×¤×¡×§ ×˜×”×¨×”",source:"auto-ready"});
  }
  for(const v of kavuah.byGap.values()){
    const d=addDays(v.start,v.gap);
    addMarker(ymd(d),{type:"prisha",label:markerLabel(`×•×¡×ª ×§×‘×•×¢ ${v.gap} ×™×•×`,v.ona),ona:v.ona,source:`auto-kavuah-gap-${v.gap}`});
  }
  for(const v of kavuah.byHebrew.values()){
    const d=addDays(v.start,29);
    addMarker(ymd(d),{type:"prisha",label:markerLabel("×•×¡×ª ×ª××¨×™×š ×§×‘×•×¢",v.ona),ona:v.ona,source:"auto-kavuah-heb"});
  }
  for(const h of hefseks){addMarker(ymd(addDays(h,7)),{type:"mikveh",label:"×˜×‘×™×œ×”",source:"auto-mikveh"});}
}
function getPhaseMap(y,m){
  const map={}; const first=new Date(y,m,1),start=addDays(first,-first.getDay());
  const periods=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="period").map(()=>new Date(k))).sort((a,b)=>a-b);
  const hefseks=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="hefsek").map(()=>new Date(k))).sort((a,b)=>a-b);
  const mikvehs=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="mikveh").map(()=>new Date(k))).sort((a,b)=>a-b);
  for(let i=0;i<42;i++){const d=addDays(start,i);const p=periods.filter(x=>x<=d).at(-1);const nextP=periods.find(x=>x>d);const h=hefseks.find(x=>p&&x>=p&&x<=d);const mk=mikvehs.find(x=>p&&x>=p&&x<=d);
    if(p&&!h)map[ymd(d)]="period";else if(h&&!mk)map[ymd(d)]="wait";else if(mk&&ymd(d)===ymd(mk))map[ymd(d)]="mikveh";else if(mk&&(!nextP||d<nextP))map[ymd(d)]="clean";
  }
  for(const [k,v] of dayEvents.entries()) if(normalizeDay(v).markers.some(x=>x.type==="prisha")) map[k]="prisha";
  return map;
}

async function getCoordsWithRetry(){
  if(lastCoords) return lastCoords;
  if(locationPromise) return locationPromise;
  locationPromise=(async()=>{
    if(!navigator.geolocation) throw new Error("no-geo");
    let lastErr=null;
    for(let attempt=1;attempt<=4;attempt++){
      try{
        const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:9000,maximumAge:0}));
        lastCoords={latitude:pos.coords.latitude,longitude:pos.coords.longitude};
        return lastCoords;
      }catch(err){
        lastErr=err;
        await new Promise(r=>setTimeout(r,1200));
      }
    }
    throw lastErr||new Error("geo-failed");
  })();
  try{return await locationPromise;}finally{locationPromise=null;}
}

async function resolveSunset(date){
  const key=ymd(date);
  const prefs=getPrefs();
  const mode=prefs.sunsetMode||"location";
  const cityKey=prefs.sunsetCity||"Jerusalem";
  const cacheKey=mode==="city"?`city-${cityKey}-${key}`:`loc-${key}`;
  if(sunsetCache[cacheKey]) return sunsetCache[cacheKey];
  try{
    let coords;
    if(mode==="city") coords=CITY_COORDS[cityKey]||CITY_COORDS.Jerusalem;
    else coords=await getCoordsWithRetry();
    const url=`https://api.sunrise-sunset.org/json?lat=${coords.latitude}&lng=${coords.longitude}&date=${key}&formatted=0`;
    const r=await fetch(url); const j=await r.json();
    const t=new Date(j.results.sunset).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    sunsetCache[cacheKey]=t;
    if(mode==="city") saveSunsetCache();
    return t;
  }catch{
    sunsetCache[cacheKey]="×˜×•×¢×Ÿ ××™×§×•×â€¦";
    setTimeout(()=>{delete sunsetCache[cacheKey];renderTodayCard();},2500);
    return "×˜×•×¢×Ÿ ××™×§×•×â€¦";
  }
}


function hasMarkerOnDate(dateKey,type){return normalizeDay(dayEvents.get(dateKey)).markers.some(m=>m.type===type)}
function getReminderLog(){try{return JSON.parse(localStorage.getItem(REMINDER_FIRE_KEY)||"{}");}catch{return {};}}
function setReminderLog(next){localStorage.setItem(REMINDER_FIRE_KEY,JSON.stringify(next));}
async function ensureNotificationPermission(){
  if(!("Notification" in window)) return false;
  if(Notification.permission==="granted") return true;
  if(Notification.permission==="denied") return false;
  const p=await Notification.requestPermission();
  return p==="granted";
}
function playReminderSound(){
  const Ctx=window.AudioContext||window.webkitAudioContext;
  if(!Ctx) return;
  const ctx=new Ctx();
  const osc=ctx.createOscillator(),gain=ctx.createGain();
  osc.type="sine"; osc.frequency.value=880; gain.gain.value=.001;
  osc.connect(gain); gain.connect(ctx.destination); osc.start();
  gain.gain.exponentialRampToValueAtTime(.28,ctx.currentTime+.03);
  gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.45);
  osc.stop(ctx.currentTime+.5);
}
async function fireHefsekReminder(dateKey){
  const log=getReminderLog();
  const time=getPrefs().reminderTime||"15:00";
  if(log[dateKey]===time) return;
  playReminderSound();
  const msg="×”×™×•× ×¦×¨×™×š ×œ×‘×¦×¢ ×”×¤×¡×§ ×˜×”×¨×”";
  const hasPermission=await ensureNotificationPermission();
  if(hasPermission){
    new Notification("×ª×–×›×•×¨×ª ×œ×•×— ×˜×”×¨×”",{body:msg,icon:"1.png"});
  }else{
    showToast(msg);
    alert(msg);
  }
  log[dateKey]=time;
  setReminderLog(log);
}
function startReminderWatcher(){
  if(reminderTimer) clearInterval(reminderTimer);
  const tick=async()=>{
    const prefs=getPrefs();
    if(!prefs.reminderEnabled) return;
    const dateKey=ymd(today);
    if(!hasMarkerOnDate(dateKey,"hefsek")) return;
    const now=new Date();
    const hhmm=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    if(hhmm>=(prefs.reminderTime||"15:00")) await fireHefsekReminder(dateKey);
  };
  tick();
  reminderTimer=setInterval(tick,30000);
}

async function renderTodayCard(){
  el("todayDate").textContent=`${new Intl.DateTimeFormat("he",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(today)} | ${getHebrewDateDisplay(today)}`;
  const sunset=await resolveSunset(today); const prefs=getPrefs(); el("todaySunset").textContent=`×©×§×™×¢×” ×œ×¤×™ ${prefs.sunsetMode==="city"?(CITY_COORDS[prefs.sunsetCity||"Jerusalem"]?.label||"×¢×™×¨"):"××™×§×•×"}: ${sunset}`;
  const dateKey=ymd(today);
  const chips=el("todayChips"); chips.innerHTML="";
  const todayMarkers=normalizeDay(dayEvents.get(dateKey)).markers;
  for(const m of todayMarkers){const c=document.createElement("span");c.className=`chip`;c.textContent=m.label;chips.appendChild(c)}
  const banner=el("todayBanner");
  if(todayMarkers.some(m=>m.type==="hefsek")){banner.textContent="âš ï¸ ×”×™×•× ×œ×‘×¦×¢ ×”×¤×¡×§ ×˜×”×¨×”";banner.classList.remove("hidden");}
  else{banner.classList.add("hidden");}
}
function startClock(){const paint=()=>el("clock").textContent=new Date().toLocaleTimeString("he-IL",{hour12:false});paint();if(clockTimer)clearInterval(clockTimer);clockTimer=setInterval(paint,1000)}

async function render(){
  const y=view.getFullYear(),m=view.getMonth(); monthTitle.textContent=new Intl.DateTimeFormat("he",{month:"long",year:"numeric"}).format(new Date(y,m,1));
  grid.innerHTML=""; const first=new Date(y,m,1),gridStart=addDays(first,-first.getDay()); const phaseMap=getPhaseMap(y,m);
  for(let i=0;i<42;i++){
    const d=addDays(gridStart,i),key=ymd(d),inMonth=d.getMonth()===m; const cell=document.createElement("div");
    const phase=phaseMap[key]; cell.className=`cell${inMonth?"":" muted"}${key===ymd(today)?" today":""}${phase?` phase-${phase}`:""}`;
    const greg=document.createElement("div");greg.className="greg";greg.textContent=d.getDate();
    const heb=document.createElement("div");heb.className="hebrew";heb.textContent=getHebrewDateDisplay(d);
    const halves=document.createElement("div");halves.className="day-halves";
    const halfNight=document.createElement("div");halfNight.className="half half-night";halfNight.innerHTML="ğŸŒ™ ×œ×™×œ×”";
    const halfDay=document.createElement("div");halfDay.className="half half-day";halfDay.innerHTML="â˜€ï¸ ×™×•×";
    const sunset=document.createElement("div");sunset.className="sunset";sunset.textContent=`×©×§×™×¢×”: â€¦`; resolveSunset(d).then(t=>sunset.textContent=`×©×§×™×¢×”: ${t}`);
    cell.append(greg,heb,halves,sunset);halves.append(halfNight,halfDay);
    for(const ev of normalizeDay(dayEvents.get(key)).markers){const b=document.createElement("div");b.className=`badge ${ev.type}`;b.textContent=ev.label;cell.appendChild(b);if(ev.ona==="night"&&/×¤×¨×™×©×”|××•×¨ ×–×¨×•×¢/.test(ev.label)){halfNight.innerHTML=`ğŸŒ™ ${ev.label}`;}if(ev.ona==="day"&&/×¤×¨×™×©×”|××•×¨ ×–×¨×•×¢/.test(ev.label)){halfDay.innerHTML=`â˜€ï¸ ${ev.label}`;}if(!ev.ona&&ev.type==="prisha"){halfNight.innerHTML=`ğŸŒ™ ${ev.label}`;halfDay.innerHTML=`â˜€ï¸ ${ev.label}`;}if(ev.type==="mikveh"){halfNight.classList.add("mikveh-night");halfNight.innerHTML="ğŸŒ™ ×œ×™×œ×” ×˜×‘×™×œ×”";}}
    cell.onclick=()=>openModal(d); grid.appendChild(cell);
  }
  await renderTodayCard();
}

function openModal(d){el("modalDateTitle").textContent=`×ª××¨×™×š: ${ymd(d)}`;el("modalDateSub").textContent=`×¢×‘×¨×™: ${getHebrewDateDisplay(d)}`;el("modalOverlay").classList.remove("hidden");
  el("btnEventA").onclick=async()=>{if(!canSetHefsek(d)){alert(`××¤×©×¨ ×œ×¡××Ÿ ×”×¤×¡×§ ×˜×”×¨×” ××”×™×•× ×”-${minhagDays()} ××ª×—×™×œ×ª ×”××—×–×•×¨.`);return;}closeModal();addMarker(ymd(d),{type:"hefsek",label:"×”×¤×¡×§ ×˜×”×¨×”"},{replaceType:true});recalcDerived();await commitAndSync();};
  el("btnEventB").onclick=()=>openOnaPicker(d);
  el("btnClear").onclick=async()=>{closeModal();dayEvents.delete(ymd(d));recalcDerived();await commitAndSync();};
}
const closeModal=()=>el("modalOverlay").classList.add("hidden");
function openOnaPicker(date){el("onaOverlay").classList.remove("hidden");const apply=async ona=>{el("onaOverlay").classList.add("hidden");closeModal();addMarker(ymd(date),{type:"period",label:markerLabel("×ª×—×™×œ×ª ××—×–×•×¨",ona),ona},{replaceType:true});recalcDerived();await commitAndSync();};el("chooseDay").onclick=()=>apply("day");el("chooseNight").onclick=()=>apply("night")}

async function commitAndSync(){await persistAll();await render();showToast("×”× ×ª×•× ×™× ×¢×•×“×›× ×•")}

function openAuth(){el("authOverlay").classList.remove("hidden")} function closeAuth(){el("authOverlay").classList.add("hidden")}
function renderAuthMode(){const t=el("authTitle"),s=el("authSub"),sw=el("authSwitchText"),a=el("authActionBtn");if(authMode==="signin"){t.textContent="×”×ª×—×‘×¨×•×ª";s.textContent="×”×ª×—×‘×¨×™ ×¢× ××™××™×™×œ ×•×¡×™×¡××”";a.textContent="×”×ª×—×‘×¨×•×ª";sw.textContent="××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?";}else{t.textContent="×¨×™×©×•×";s.textContent="×¦×¨×™ ×—×©×‘×•×Ÿ ×—×“×©";a.textContent="×¨×™×©×•×";sw.textContent="×™×© ×œ×š ×›×‘×¨ ×—×©×‘×•×Ÿ?";}}
async function doSignIn(){try{await signInWithEmailAndPassword(auth,el("email").value,el("password").value);closeAuth();}catch(e){el("authMsg").textContent="×©×’×™××ª ×”×ª×—×‘×¨×•×ª: "+e.message}}
async function doSignUp(){try{await createUserWithEmailAndPassword(auth,el("email").value,el("password").value);closeAuth();}catch(e){el("authMsg").textContent="×©×’×™××ª ×¨×™×©×•×: "+e.message}}

onAuthStateChanged(auth,async user=>{currentUid=user?.uid||null;authState.textContent=user?`××—×•×‘×¨: ${user.email}`:"×œ× ××—×•×‘×¨";if(user){await loadRemoteEvents(user.uid);await persistAll();}recalcDerived();await render();});

el("prevMonth").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()-1,1);render()};
el("nextMonth").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()+1,1);render()};
el("modalClose").onclick=closeModal; el("modalOverlay").onclick=e=>{if(e.target===el("modalOverlay"))closeModal()};
el("onaCancel").onclick=()=>el("onaOverlay").classList.add("hidden"); el("onaOverlay").onclick=e=>{if(e.target===el("onaOverlay"))el("onaOverlay").classList.add("hidden")};
const openDrawer=()=>{el("drawer").classList.remove("hidden");el("drawerBackdrop").classList.remove("hidden")}; const closeDrawer=()=>{el("drawer").classList.add("hidden");el("drawerBackdrop").classList.add("hidden")};
el("menuBtn").onclick=openDrawer; el("closeDrawer").onclick=closeDrawer; el("drawerBackdrop").onclick=closeDrawer;
el("openAuthFromMenu").onclick=()=>{openAuth();closeDrawer()}; el("authClose").onclick=closeAuth;

const darkToggle=el("darkToggle"),day31Toggle=el("day31Toggle"),day30Mode=el("day30Mode"),day31Mode=el("day31Mode"),minhagSelect=el("minhagSelect"),reminderToggle=el("reminderToggle"),meetingToggle=el("meetingToggle"),reminderTime=el("reminderTime"),sunsetMode=el("sunsetMode"),sunsetCity=el("sunsetCity");
const prefs=getPrefs(); darkToggle.checked=!!prefs.dark; day31Toggle.checked=!!prefs.day31; day30Mode.value=prefs.day30Mode||"ona"; day31Mode.value=prefs.day31Mode||"ona"; minhagSelect.value=prefs.minhag||"sephardi"; reminderToggle.checked=!!prefs.reminderEnabled; meetingToggle.checked=!!prefs.meetingReminders; reminderTime.value=prefs.reminderTime||"15:00"; sunsetMode.value=prefs.sunsetMode||"location"; sunsetCity.value=prefs.sunsetCity||"Jerusalem"; if(prefs.dark)document.body.classList.add("dark");
darkToggle.onchange=e=>{document.body.classList.toggle("dark",e.target.checked);setPrefs({dark:e.target.checked})};
day31Toggle.onchange=async e=>{setPrefs({day31:e.target.checked});recalcDerived();await commitAndSync()};
day30Mode.onchange=async e=>{setPrefs({day30Mode:e.target.value});recalcDerived();await commitAndSync()};
day31Mode.onchange=async e=>{setPrefs({day31Mode:e.target.value});recalcDerived();await commitAndSync()};
minhagSelect.onchange=async e=>{setPrefs({minhag:e.target.value});recalcDerived();await commitAndSync()};
reminderToggle.onchange=async e=>{setPrefs({reminderEnabled:e.target.checked});if(e.target.checked)await ensureNotificationPermission();startReminderWatcher();showToast("×”×ª×–×›×•×¨×ª ×¢×•×“×›× ×”")};
meetingToggle.onchange=e=>{setPrefs({meetingReminders:e.target.checked});showToast("×ª×–×›×•×¨×ª ×™××™ ×¤×’×™×©×” ×¢×•×“×›× ×”")};
reminderTime.onchange=e=>{setPrefs({reminderTime:e.target.value||"15:00"});startReminderWatcher();showToast("×©×¢×ª ×”×ª×–×›×•×¨×ª ×¢×•×“×›× ×”")};
sunsetMode.onchange=async e=>{setPrefs({sunsetMode:e.target.value});await render();};
sunsetCity.onchange=async e=>{setPrefs({sunsetCity:e.target.value});await render();};

el("authActionBtn").onclick=()=>authMode==="signin"?doSignIn():doSignUp();
el("authSwitchBtn").onclick=e=>{e.preventDefault();authMode=authMode==="signin"?"signup":"signin";renderAuthMode()};
el("signOutBtn").onclick=async()=>{await signOut(auth);el("authMsg").textContent="×”×ª× ×ª×§×ª"};

startClock(); renderAuthMode(); if(!localStorage.getItem(AUTH_PROMPT_KEY)){openAuth();localStorage.setItem(AUTH_PROMPT_KEY,"1")} recalcDerived(); startReminderWatcher(); render();
</script>
</body>
</html>
