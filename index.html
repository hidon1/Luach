<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×œ×•×—</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@500;700;800&family=David+Libre:wght@500;700&display=swap');
    :root {
      --bg:#eedff8;
      --bg-2:#f5d0ee;
      --card:#ffffffde;
      --text:#2a2042;
      --muted:#6f628f;
      --line:#e8d8eb;
      --accent:#c64d88;
      --shadow:0 10px 30px rgba(160,74,126,.15);
      --pink:#ffc0d4;
      --green:#beefd0;
      --warn:#fff3a8;
    }
    body.dark{--bg:#1e1527;--bg-2:#2d1c36;--card:#2c2036e6;--text:#f6eaff;--muted:#ceb5da;--line:#4d395b;--accent:#e67db1;--shadow:0 12px 30px rgba(0,0,0,.35);--pink:#473040;--green:#30483a;--warn:#4b432d}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Assistant","Noto Sans Hebrew","Segoe UI","Arial",sans-serif;font-weight:650;letter-spacing:.01em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:geometricPrecision;color:#201735;background:linear-gradient(160deg,var(--bg),var(--bg-2));min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(120deg,transparent 0 22px,rgba(210,80,160,.13) 22px 24px,transparent 24px 46px);animation:bgMove 14s linear infinite;opacity:1;z-index:-1}
    .hidden{display:none!important}
    .topbar{position:relative;z-index:30;padding:6px 16px 0;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:start;background:transparent;border-bottom:none}
    .brand{display:flex;align-items:flex-start;justify-content:center;gap:16px;justify-self:center;padding:0 8px;width:min(980px,100%);margin-inline:auto;margin-top:0}
    .logo{width:min(680px,64vw);height:168px;max-width:100%;object-fit:cover;object-position:center 56%;background:transparent;border:none;box-shadow:none;display:block;pointer-events:none}
    .brand-title-wrap{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
    .brand-title{margin:0;font-size:clamp(2.15rem,4.8vw,3.35rem);font-family:"David Libre","Assistant","Noto Sans Hebrew",serif;font-weight:700;line-height:1;letter-spacing:.01em;color:#8d6a9c;text-shadow:0 2px 10px rgba(87,49,110,.2)}
    .brand-subtitle{margin:0;font-size:1.05rem;font-weight:900;color:#5f1648;text-shadow:0 2px 10px rgba(255,255,255,.45)}
    .menu-btn{justify-self:end;position:fixed;right:16px;top:10px;z-index:60;font-size:1.45rem;padding:11px 17px;border-radius:16px;background:linear-gradient(180deg,#ffffff,#f7f4ff);color:#2d1d49;border:1px solid #d7c7eb;box-shadow:0 6px 18px rgba(70,36,105,.18);font-weight:900}
    .menu-btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(70,36,105,.22)}
    .today-panel{justify-self:start;position:fixed;left:16px;top:52px;z-index:58;min-width:204px;max-width:218px;padding:12px 10px;border-radius:20px;background:linear-gradient(180deg,#fff,#f0fff6);border:1px solid #cdeedb;box-shadow:var(--shadow);cursor:pointer;transition:.2s}
    .today-panel:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(35,83,61,.2)}
    .today-head{display:flex;justify-content:space-between;font-weight:800}.clock{font-size:1.1rem;font-weight:900;color:#fff;background:linear-gradient(145deg,#6a2a58,var(--accent));padding:6px 12px;border-radius:999px;letter-spacing:.04em;box-shadow:0 5px 14px rgba(110,44,90,.28)}.small{font-size:.82rem;color:#4d406f;font-weight:700}
    .chip-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{padding:4px 10px;border-radius:999px;font-size:.78rem;border:1px solid var(--line);background:#fff}
    .container{max-width:1100px;margin:8px auto 0;padding:0 14px 30px;display:grid;gap:12px;position:relative;z-index:40}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .controls{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px}.month-scroll-hint{display:none}
    .monthTitle{font-weight:900;min-width:280px;text-align:center;padding:13px 18px;border-radius:18px;background:linear-gradient(140deg,#f6c7ff,#8f327f 74%);border:1px solid #742869;color:#fff;box-shadow:0 6px 0 #6a1e5b,0 14px 28px rgba(109,30,103,.28),inset 0 2px 8px rgba(255,255,255,.3);text-shadow:0 2px 7px rgba(69,15,80,.45)}
    .btn{border:1px solid var(--line);background:#ffffffd9;border-radius:14px;padding:9px 12px;font-weight:800;cursor:pointer;color:#23193a;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(103,48,130,.15)}
    .controls{flex-wrap:wrap}
    .month-nav{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;width:100%}
    .month-extra{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;width:100%}
    .btn-toggle-active{background:#311b52;color:#fff;border-color:#311b52}
    .continuous-wrap{display:none;padding:12px}
    .continuous-wrap.active{display:block}
    .continuous-track{display:flex;flex-direction:column;gap:12px;padding:4px}
    .continuous-month{border:1px solid var(--line);border-radius:16px;background:#fff;padding:14px}
    .continuous-month-title{font-weight:900;text-align:center;margin-bottom:10px;color:#2f1f48}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#8b2060);color:#fff;border-color:transparent;box-shadow:0 4px 14px rgba(180,50,120,.3)}
    .calendar{padding:18px 12px 12px}
    .dow,.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{margin-bottom:10px}.dow div{text-align:center;padding:10px 6px;border:1px solid var(--line);border-radius:10px;font-size:.9rem;color:var(--muted);font-weight:800;white-space:nowrap;overflow:visible;line-height:1.2}
    .cell{min-height:120px;padding:8px;border-radius:14px;border:1px solid var(--line);background:#fdf8f0;cursor:pointer;transition:.2s;position:relative}
    .cell:hover{transform:translateY(-2px)}
    .muted{opacity:.45}
    .today{outline:2px solid var(--accent)}
    .today .greg,.today .hebrew{font-weight:900;color:#9a205f}
    .phase-period{background:var(--pink)}
    .phase-wait{background:#ffffff}
    .phase-clean{background:#b2efbc}
    .phase-mikveh{background:#a8e4f5}
    .phase-prisha{background:var(--warn)}
    .greg{font-size:1.2rem;font-weight:800;margin-bottom:3px}
    .hebrew{font-size:.83rem;color:#2a1742;margin-bottom:7px;font-weight:900}
    .sunset{font-size:.74rem;color:#6f1f4b;margin-top:5px;font-weight:800}
    .badge{display:inline-flex;align-items:center;gap:6px;margin-top:5px;padding:4px 10px;border-radius:999px;font-size:.78rem;background:#fff;border:1px solid var(--line);cursor:pointer;font-weight:900;color:#2a163f;letter-spacing:.01em}
    .badge-note-dot{width:8px;height:8px;border-radius:50%;background:#ff4f8a;box-shadow:0 0 0 3px rgba(255,79,138,.2)}
    .badge.period{background:#ffd6e8}.badge.hefsek{background:#e5ffe9}.badge.mikveh{background:#c7efff}.badge.prisha{background:#fff2b8}.badge.orzarua{background:#ffeedf}.badge.hefsekReady{background:#dcffe8}
    .time-input{padding:10px 14px;border:1px solid #d8b4f1;border-radius:999px;background:linear-gradient(120deg,#fff,#ffeefe);font-weight:800;color:#24183c;min-width:140px;box-shadow:inset 0 1px 0 #fff,0 3px 10px rgba(182,90,155,.12)}
    .switch.reminder-card{display:block;background:linear-gradient(150deg,#fff6fd,#ffe8f5);border:1px solid #f1bdd9;border-radius:14px;padding:10px}
    .reminder-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
    .reminder-grid .switch{margin:0}
    .day-halves{display:grid;grid-template-columns:1fr 1fr;position:relative;border-radius:10px;overflow:hidden;border:1px solid #eaddea;margin-bottom:4px}
    .day-halves::before{content:"";position:absolute;top:0;bottom:0;left:50%;width:1px;background:#d7c6de}
    .half{padding:2px 4px;min-height:18px;font-size:.62rem;display:flex;gap:3px;align-items:center;justify-content:center}
    .half-night{background:rgba(142,119,161,.08)}
    .half-night.mikveh-night{background:#b98ce4;color:#fff;font-weight:800}
    .half-day{background:rgba(255,202,94,.12)}
    .half-empty{opacity:.45;color:#7a6b91}
    .drawer-backdrop{position:fixed;inset:0;background:#0006;z-index:40}
    .drawer{position:fixed;top:0;right:0;bottom:0;width:min(390px,92vw);z-index:41;background:linear-gradient(180deg,#fef0ff,#ead8ff);border-left:2px solid var(--accent);padding:18px;display:grid;gap:12px;align-content:start;box-shadow:-16px 0 40px rgba(120,40,200,.2);overflow-y:auto}
    body.dark .drawer{background:linear-gradient(180deg,#31253a,#281d30)}
    .switch{display:flex;justify-content:space-between;align-items:center;padding:11px 14px;border-radius:14px;border:1px solid #d4b8f0;background:linear-gradient(145deg,#ffffff,#f3e8ff);gap:8px;box-shadow:0 2px 8px rgba(130,70,200,.08);font-weight:800;color:#31154e}
    .switch-feature{background:linear-gradient(145deg,#fff,#f7ecff);border:1px solid #c9a6ea;box-shadow:inset 0 1px 0 #fff,0 8px 16px rgba(130,70,200,.12)}
    .switch-feature span{font-weight:900;color:#3c1d58}
    .ona-modal{background:linear-gradient(160deg,#fff,#f4e7ff);border:1px solid #dcc1f5}
    .ona-title{font-size:1.08rem;font-weight:900;color:#401562;margin-bottom:6px}
    .ona-actions .btn{min-width:96px}

    .switch input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:56px;height:30px;border-radius:999px;background:#b8bfd3;position:relative;cursor:pointer;transition:background .2s ease;overflow:hidden}
    .switch input[type="checkbox"]::after{content:"";position:absolute;top:3px;right:3px;width:24px;height:24px;border-radius:50%;background:#fff;transition:transform .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .switch input[type="checkbox"]:checked{background:#2f8cff}
    .switch input[type="checkbox"]:checked::after{transform:translateX(-26px)}
    .drawer-head{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--accent);padding-bottom:10px;margin-bottom:2px}
    .drawer-head h3{margin:0;font-size:1.3rem;color:#4a1070;font-weight:900;letter-spacing:.02em}
    .drawer-close{margin-inline-start:auto;font-size:.85rem;padding:6px 9px;min-width:unset}
    .modal-overlay{position:fixed;inset:0;background:rgba(48,22,73,.35);backdrop-filter:blur(4px);display:grid;place-items:center;z-index:60;padding:12px}
    .modal{width:min(560px,95vw);padding:16px;border-radius:22px;background:linear-gradient(180deg,#fff,#fef5ff);border:1px solid #edc9f4;box-shadow:0 20px 60px rgba(80,26,109,.25)}
    .modal-head{display:flex;justify-content:space-between;align-items:flex-start}
    .modal-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .modal-title{font-size:1.2rem;font-weight:900;color:#41125e}
    #btnEventA{background:#fff;color:#23193a}
    #btnEventB{background:linear-gradient(135deg,var(--accent),#8b2060);color:#fff;border-color:transparent;box-shadow:0 4px 14px rgba(180,50,120,.3)}
    .auth-form{display:grid;gap:8px;margin-top:10px}input,select{padding:8px;border-radius:12px;border:1px solid var(--line)}
    .drawer select,#day30Mode,#day31Mode,#minhagSelect,#timelineFilter{border-radius:999px;padding:10px 14px;background:linear-gradient(120deg,#fff,#f6ebff);border:1px solid #d4b8f0;font-weight:900;color:#34174f;box-shadow:inset 0 1px 0 #fff,0 4px 10px rgba(130,70,200,.1)}
    .toast{position:fixed;left:16px;bottom:16px;padding:10px;border-radius:12px;background:var(--card);border:1px solid var(--line)}
    .today-banner{margin-top:8px;padding:8px 10px;border-radius:12px;background:linear-gradient(120deg,#e6fff1,#bff0d7);border:1px solid #79cfa2;color:#14643a;font-weight:800;font-size:.9rem;box-shadow:var(--shadow)}
    .timeline-toolbar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;background:linear-gradient(145deg,#fff,#f4e9ff);border:1px solid #ddc3f5;margin-top:10px;font-weight:900;color:#3b1956}
    .timeline-list{display:grid;gap:8px;margin-top:12px;max-height:52vh;overflow:auto;padding-inline-end:4px}
    .timeline-item{padding:10px;border-radius:12px;background:#fff;border:1px solid #ead5f5;display:grid;gap:4px}
    .timeline-item small{color:#5b2f74;font-weight:700}
    .notes-list{margin:0;padding-right:16px;display:grid;gap:6px}
    .notes-list li{font-size:.88rem;color:#3f2a54}
    .note-editor{display:grid;gap:10px;margin-top:10px}
    .note-editor textarea{width:100%;min-height:110px;resize:vertical;border-radius:14px;border:1px solid #ddb7ec;padding:10px;font-family:inherit;background:#fff}
    body.dark .today-banner{background:linear-gradient(120deg,#5b3047,#4c2038);color:#ffd7e8;border-color:#7f4964}
    @keyframes bgMove{from{transform:translateX(0)}to{transform:translateX(90px)}}
    @media(max-width:1280px) and (min-width:721px){.brand{width:100%;justify-self:center;align-items:center;margin-top:8px}.logo{width:min(480px,68vw);height:auto;max-height:116px;object-fit:contain;object-position:center center}.topbar{padding:8px 12px 0}.container{margin:10px auto 0}.brand-subtitle{font-size:.95rem}}
    @media(max-width:1024px) and (min-width:721px){.calendar,.controls{padding:10px}.dow,.grid{gap:6px}.dow div{padding:8px 4px;font-size:.8rem}.cell{min-height:82px;padding:6px}.greg{font-size:.95rem}.hebrew{font-size:.76rem}.drawer{width:min(420px,94vw)}.menu-btn{right:12px}.today-panel{left:12px;top:50px}}
    @media(max-width:900px){.topbar{grid-template-columns:1fr auto;}.today-panel{min-width:176px;max-width:190px}.brand{justify-self:center}.controls{flex-wrap:wrap}.monthTitle{min-width:220px}}
    @media(max-width:720px){.container{padding:0 10px 22px;margin:6px auto 0}.calendar,.controls{padding:10px}.dow,.grid{gap:5px}.dow div{padding:7px 3px;font-size:.72rem}.cell{min-height:72px;padding:5px}.greg{font-size:.9rem}.hebrew{font-size:.7rem}.sunset{font-size:.64rem}.menu-btn{padding:10px 14px;font-size:1.2rem;border-radius:14px;right:10px;top:8px}.brand{gap:10px;justify-self:center;align-items:center}.logo{width:min(50vw,140px);height:auto;max-height:46px;object-fit:contain;object-position:center center}.brand-subtitle{font-size:.84rem}.monthTitle{min-width:230px;padding:11px 14px}.today-panel{left:10px;top:44px;min-width:160px;max-width:172px;padding:10px 8px}}
  </style>
</head>
<body>
<header class="topbar">
  <button id="menuBtn" class="btn menu-btn">â˜°</button>
  <div class="brand">
    <img class="logo" src="logo.png" alt="×œ×•×’×• ×œ×•×— ×˜×”×¨×”" />
  </div>
  <section class="today-panel" id="todayPanel">
    <div class="today-head"><span>×”×™×•×</span><span id="clock" class="clock">--:--:--</span></div>
    <div class="small" id="todayDate"></div>
    <div class="small" id="todaySunset">×©×§×™×¢×”: ×˜×•×¢×Ÿ ×œ×¤×™ ××™×§×•×â€¦</div>
    <div id="todayBanner" class="today-banner hidden"></div>
    <div id="todayChips" class="chip-wrap"></div>
  </section>
</header>
<main class="container">
  <section class="controls card">
    <div class="month-nav">
      <button id="prevMonth" class="btn">â–¶ ×—×•×“×© ×§×•×“×</button>
      <div id="monthTitle" class="monthTitle"></div>
      <button id="nextMonth" class="btn">×—×•×“×© ×”×‘× â—€</button>
      <button id="toggleContinuous" class="btn">×ª×¦×•×’×ª ×’×œ×™×œ×” ×¨×¦×™×¤×”</button>
    </div>
  </section>
  <section id="calendar" class="calendar card">
    <div class="dow"><div>×™×•× ××³</div><div>×™×•× ×‘×³</div><div>×™×•× ×’×³</div><div>×™×•× ×“×³</div><div>×™×•× ×”×³</div><div>×™×•× ×•×³</div><div>×©×‘×ª</div></div>
    <div id="grid" class="grid"></div>
  </section>
  <section id="continuousWrap" class="continuous-wrap card">
    <div id="continuousTrack" class="continuous-track"></div>
  </section>
</main>
<footer style="text-align:center;padding:22px;color:var(--muted);font-weight:700">× ×‘× ×” ×¢×œ ×™×“×™ ×™×³.×–×³.××³ â€” ×œ×¤×¨×˜×™×: <a href="https://hidon1.github.io/a/" target="_blank" rel="noopener" style="color:var(--accent);font-weight:800">×œ×—×¥ ×›××Ÿ</a>.</footer>
<div id="drawerBackdrop" class="drawer-backdrop hidden"></div>
<aside id="drawer" class="drawer hidden">
  <div class="drawer-head"><h3>×ª×¤×¨×™×˜</h3><button id="closeDrawer" class="btn drawer-close">âœ•</button></div>
  <div class="switch"><span>×× ×”×’</span><select id="minhagSelect"><option value="sephardi">×¡×¤×¨×“×™×</option><option value="ashkenazi">××©×›× ×–×™×</option></select></div>
  <div class="switch"><span>×™×•× 31</span><input id="day31Toggle" type="checkbox"></div>
  <div class="switch switch-feature"><span>××•×¤×Ÿ ×¢×•× ×” ×‘×™× ×•× ×™×ª (30)</span><select id="day30Mode"><option value="ona">×¨×§ ×¢×•× ×ª ×¨××™×™×”</option><option value="full">×›×œ ×”×™×•× (×™×•×+×œ×™×œ×”)</option></select></div>
  <div class="switch switch-feature"><span>××•×¤×Ÿ ×™×•× 31</span><select id="day31Mode"><option value="ona">×¨×§ ×¢×•× ×ª ×¨××™×™×”</option><option value="full">×›×œ ×”×™×•× (×™×•×+×œ×™×œ×”)</option></select></div>
  <div class="switch reminder-card">
    <span>×ª×–×›×•×¨×•×ª ×—×›××•×ª</span>
    <div class="reminder-grid">
      <div class="switch"><span>×ª×–×›×•×¨×ª ×œ×”×¤×¡×§ ×˜×”×¨×”</span><input id="reminderToggle" type="checkbox"></div>
      <div class="switch"><span>×ª×–×›×•×¨×ª ×œ×™××™ ×¤×¨×™×©×”</span><input id="meetingToggle" type="checkbox"></div>
      <div class="switch" style="grid-column:1/-1"><span>×©×¢×ª ×ª×–×›×•×¨×ª</span><input id="reminderTime" class="time-input" type="time" value="15:00"></div>
    </div>
  </div>
  <button id="openTimeline" class="btn">×¦×™×¨ ×”×–××Ÿ</button>
  <div class="switch switch-feature"><span>×©×§×™×¢×” ×œ×¤×™</span><select id="sunsetMode"><option value="location">××§×•× × ×•×›×—×™ (××©×ª× ×”)</option><option value="city">×¢×™×¨ ×§×‘×•×¢×”</option></select></div>
  <div class="switch switch-feature"><span>×¢×™×¨ ×§×‘×•×¢×”</span><select id="sunsetCity"><option value="Jerusalem">×™×¨×•×©×œ×™×</option><option value="Tel Aviv">×ª×œ ××‘×™×‘</option><option value="Haifa">×—×™×¤×”</option><option value="Rishon LeZion">×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</option><option value="Petah Tikva">×¤×ª×— ×ª×§×•×•×”</option><option value="Ashdod">××©×“×•×“</option><option value="Netanya">× ×ª× ×™×”</option><option value="Beersheba">×‘××¨ ×©×‘×¢</option><option value="Bnei Brak">×‘× ×™ ×‘×¨×§</option><option value="Holon">×—×•×œ×•×Ÿ</option><option value="Ramat Gan">×¨××ª ×’×Ÿ</option><option value="Ashkelon">××©×§×œ×•×Ÿ</option><option value="Rehovot">×¨×—×•×‘×•×ª</option><option value="Bat Yam">×‘×ª ×™×</option><option value="Herzliya">×”×¨×¦×œ×™×”</option><option value="Kfar Saba">×›×¤×¨ ×¡×‘×</option><option value="Modiin">××•×“×™×¢×™×Ÿ</option><option value="Nazareth">× ×¦×¨×ª</option><option value="Hadera">×—×“×¨×”</option><option value="Eilat">××™×œ×ª</option></select></div>
  <div class="switch"><span>××¦×‘ ×›×”×”</span><input id="darkToggle" type="checkbox"></div>
  <button id="openAuthFromMenu" class="btn btn-primary">×”×ª×—×‘×¨×•×ª / ×”×¨×©××”</button>
  <div id="authState" class="small">×œ× ××—×•×‘×¨</div>
</aside>
<div id="modalOverlay" class="modal-overlay hidden"><div class="modal card"><div class="modal-head"><div><div id="modalDateTitle"></div><div id="modalDateSub" class="small"></div></div><button id="modalClose" class="btn">âœ•</button></div><div class="modal-actions"><button id="btnEventA" class="btn">×”×¤×¡×§ ×˜×”×¨×”</button><button id="btnEventB" class="btn">×ª×—×™×œ×ª ××—×–×•×¨</button><button id="btnClear" class="btn">× ×§×”</button></div></div></div>
<div id="onaOverlay" class="modal-overlay hidden"><div class="modal card ona-modal" style="max-width:360px"><div class="ona-title">×‘×—×™×¨×ª ×¢×•× ×” ×œ×ª×—×™×œ×ª ××—×–×•×¨</div><div class="small">××¤×©×¨ ×œ×‘×—×•×¨ ×¢×•× ×ª ×¨××™×™×” ×‘×œ×‘×“ ××• ×œ×¡××Ÿ ×¢×•× ×” ××—×¨×ª ×‘××™×“×ª ×”×¦×•×¨×š.</div><div class="modal-actions ona-actions"><button id="chooseDay" class="btn btn-primary">â˜€ï¸ ×™×•×</button><button id="chooseNight" class="btn">ğŸŒ™ ×œ×™×œ×”</button><button id="onaCancel" class="btn">×‘×™×˜×•×œ</button></div></div></div>
<div id="authOverlay" class="modal-overlay hidden"><div class="modal card" style="max-width:420px"><div class="modal-head"><div><div id="authTitle">×”×ª×—×‘×¨×•×ª</div><div id="authSub" class="small"></div></div><button id="authClose" class="btn">âœ•</button></div><form class="auth-form"><input id="email" type="email" placeholder="××™××™×™×œ" required><input id="password" type="password" placeholder="×¡×™×¡××”" required><button id="authActionBtn" type="button" class="btn btn-primary">×”×ª×—×‘×¨×•×ª</button><button id="signOutBtn" type="button" class="btn">×”×ª× ×ª×§×•×ª</button></form><div class="small"><span id="authSwitchText"></span> <button id="authSwitchBtn" class="btn">×œ×—×¥ ×›××Ÿ</button></div><div id="authMsg" class="small"></div></div></div>
<div id="timelineOverlay" class="modal-overlay hidden"><div class="modal card"><div class="modal-head"><div><div class="modal-title">×¦×™×¨ ×”×–××Ÿ</div><div class="small">×›×œ ×”×¢×“×›×•× ×™× ×”××—×¨×•× ×™× ×œ×¤×™ ×ª××¨×™×š</div></div><button id="timelineClose" class="btn">âœ•</button></div><div class="timeline-toolbar"><label for="timelineFilter">×¡×™× ×•×Ÿ:</label><select id="timelineFilter"><option value="all">×”×›×œ</option><option value="period">×ª×—×™×œ×ª ××—×–×•×¨ ×‘×œ×‘×“</option><option value="prisha">×™××™ ×¤×¨×™×©×” ×‘×œ×‘×“</option></select></div><div id="timelineList" class="timeline-list"></div></div></div>
<div id="noteOverlay" class="modal-overlay hidden"><div class="modal card" style="max-width:460px"><div class="modal-head"><div><div id="noteTitle" class="modal-title">×”×¢×¨×”</div><div id="noteSub" class="small"></div></div><button id="noteClose" class="btn">âœ•</button></div><div class="note-editor"><textarea id="noteInput" placeholder="×›×ª×‘×™ ×›××Ÿ ×”×¢×¨×”..."></textarea><div class="modal-actions"><button id="saveNoteBtn" class="btn btn-primary">×©××•×¨</button><button id="deleteNoteBtn" class="btn">××—×§ ×”×¢×¨×”</button><button id="cancelNoteBtn" class="btn">×‘×™×˜×•×œ</button></div></div><div><div class="small">×”×¢×¨×•×ª ×§×•×“××•×ª:</div><ul id="noteHistory" class="notes-list"></ul></div></div></div>
<div id="toast" class="toast hidden"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
<script>

const firebaseConfig={apiKey:"AIzaSyDiN-q4MWmKLqMpjtbevW5sTGXgoFOyQ94",authDomain:"luach-48111.firebaseapp.com",projectId:"luach-48111",storageBucket:"luach-48111.firebasestorage.app",messagingSenderId:"418216623160",appId:"1:418216623160:web:56ebe2830458d6b12f3acd",measurementId:"G-BJ2LVM6WR6"};
firebase.initializeApp(firebaseConfig);
try{firebase.analytics();}catch{}
const auth=firebase.auth();
const db=firebase.firestore();

const el=id=>document.getElementById(id);
const grid=el("grid"),monthTitle=el("monthTitle"),authState=el("authState"),toast=el("toast");
const today=startOfDay(new Date()); let view=new Date(today.getFullYear(),today.getMonth(),1); let continuousMode=false;
const STORAGE_KEY="calendar_events_v7",PREFS_KEY="calendar_prefs_v6",AUTH_PROMPT_KEY="auth_prompt_seen_v2",REMINDER_FIRE_KEY="hefsek_reminder_fired_v1",SUNSET_CITY_CACHE_KEY="sunset_city_cache_v1",NOTE_HISTORY_KEY="calendar_note_history_v1";
let dayEvents=loadLocalEvents(),currentUid=null,authMode="signin",clockTimer=null,sunsetCache=loadSunsetCache(),locationPromise=null,lastCoords=null,reminderTimer=null;
let webViewSafeReady=false;
const CITY_COORDS={"Jerusalem":{latitude:31.7683,longitude:35.2137,label:"×™×¨×•×©×œ×™×"},"Tel Aviv":{latitude:32.0853,longitude:34.7818,label:"×ª×œ ××‘×™×‘"},"Haifa":{latitude:32.794,longitude:34.9896,label:"×—×™×¤×”"},"Rishon LeZion":{latitude:31.973,longitude:34.7925,label:"×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ"},"Petah Tikva":{latitude:32.084,longitude:34.8878,label:"×¤×ª×— ×ª×§×•×•×”"},"Ashdod":{latitude:31.8014,longitude:34.6435,label:"××©×“×•×“"},"Netanya":{latitude:32.3215,longitude:34.8532,label:"× ×ª× ×™×”"},"Beersheba":{latitude:31.252,longitude:34.7915,label:"×‘××¨ ×©×‘×¢"},"Bnei Brak":{latitude:32.0836,longitude:34.8328,label:"×‘× ×™ ×‘×¨×§"},"Holon":{latitude:32.0158,longitude:34.7874,label:"×—×•×œ×•×Ÿ"},"Ramat Gan":{latitude:32.0684,longitude:34.8248,label:"×¨××ª ×’×Ÿ"},"Ashkelon":{latitude:31.6688,longitude:34.5743,label:"××©×§×œ×•×Ÿ"},"Rehovot":{latitude:31.8948,longitude:34.8113,label:"×¨×—×•×‘×•×ª"},"Bat Yam":{latitude:32.0171,longitude:34.7454,label:"×‘×ª ×™×"},"Herzliya":{latitude:32.1663,longitude:34.8433,label:"×”×¨×¦×œ×™×”"},"Kfar Saba":{latitude:32.1743,longitude:34.907,label:"×›×¤×¨ ×¡×‘×"},"Modiin":{latitude:31.8996,longitude:35.0097,label:"××•×“×™×¢×™×Ÿ"},"Nazareth":{latitude:32.6996,longitude:35.3035,label:"× ×¦×¨×ª"},"Hadera":{latitude:32.434,longitude:34.9197,label:"×—×“×¨×”"},"Eilat":{latitude:29.5577,longitude:34.9519,label:"××™×œ×ª"}};

function pad2(n){return String(n).padStart(2,"0")} function ymd(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function startOfDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())} function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return startOfDay(x)}
function numberToHebrewDay(n){const ones=["","×","×‘","×’","×“","×”","×•","×–","×—","×˜"],tens=["","×™","×›","×œ"];if(n===15)return"×˜×´×•";if(n===16)return"×˜×´×–";if(n<10)return `${ones[n]}×³`;if(n%10===0)return `${tens[n/10]}×³`;return `${tens[Math.floor(n/10)]}×´${ones[n%10]}`}
function getHebrewDateDisplay(d){const parts=new Intl.DateTimeFormat("he-u-ca-hebrew",{day:"numeric",month:"long"}).formatToParts(d);const day=Number(parts.find(p=>p.type==="day")?.value||1);const month=parts.find(p=>p.type==="month")?.value||"";return `${numberToHebrewDay(day)} ${month}`}
const markerIcon=o=>o==="day"?"â˜€ï¸":"ğŸŒ™"; const markerLabel=(b,o)=>o?`${b} ${markerIcon(o)}`:b;
const normalizeDay=v=>!v?{markers:[]}:Array.isArray(v.markers)?v:v.type?{markers:[v]}:{markers:[]};
function loadLocalEvents(){try{return new Map(Object.entries(JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")));}catch{return new Map();}}
function getPrefs(){try{return JSON.parse(localStorage.getItem(PREFS_KEY)||"{}");}catch{return {};}}
function exportEvents(){const o={};for(const[k,v]of dayEvents.entries())o[k]=normalizeDay(v);return o;}
function addMarker(dateKey,marker,{replaceType=false}={}){const day=normalizeDay(dayEvents.get(dateKey));if(replaceType)day.markers=day.markers.filter(m=>m.type!==marker.type);if(!day.markers.some(m=>m.type===marker.type&&m.ona===marker.ona&&m.source===marker.source))day.markers.push(marker);dayEvents.set(dateKey,day)}
function clearDerived(){for(const [k,v]of dayEvents.entries()){const keep=normalizeDay(v).markers.filter(m=>!m.source);keep.length?dayEvents.set(k,{markers:keep}):dayEvents.delete(k)}}
async function persistAll(){const events=exportEvents();localStorage.setItem(STORAGE_KEY,JSON.stringify(events));if(currentUid)await db.collection("users").doc(currentUid).set({events,prefs:getPrefs(),updatedAt:Date.now()},{merge:true})}
function setPrefs(next){localStorage.setItem(PREFS_KEY,JSON.stringify({...getPrefs(),...next}));persistAll();}
function loadSunsetCache(){try{return JSON.parse(localStorage.getItem(SUNSET_CITY_CACHE_KEY)||"{}");}catch{return {};}}
function saveSunsetCache(){localStorage.setItem(SUNSET_CITY_CACHE_KEY,JSON.stringify(sunsetCache));}

async function loadRemoteEvents(uid){const snap=await db.collection("users").doc(uid).get();if(!snap.exists)return;const data=snap.data();if(data.events)dayEvents=new Map(Object.entries(data.events));if(data.prefs)localStorage.setItem(PREFS_KEY,JSON.stringify({...getPrefs(),...data.prefs}));}
function showToast(msg){toast.textContent=msg;toast.classList.remove("hidden");setTimeout(()=>toast.classList.add("hidden"),1600)}

function minhagDays(){const m=getPrefs().minhag||"sephardi";return m==="ashkenazi"?5:4}
function canSetHefsek(d){const periods=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(m=>m.type==="period").map(()=>new Date(k))).sort((a,b)=>a-b);const last=periods.filter(p=>p<=d).at(-1);if(!last)return false;return startOfDay(d)>=addDays(last,minhagDays()-1)}
function getPrishaOnotForMode(baseOna,mode){return mode==="full"?["night","day"]:[baseOna];}
function addPrishaMarkers(date,onot,label,source){for(const ona of onot){addMarker(ymd(date),{type:"prisha",label:markerLabel(label,ona),ona,source});}}
function calculateKavuah(patterns){
  const byGap=new Map(),byHebrew=new Map();
  if(patterns.length<3) return {byGap,byHebrew};
  for(let i=0;i<=patterns.length-3;i++){
    const a=patterns[i],b=patterns[i+1],c=patterns[i+2];
    const gap1=Math.round((b.date-a.date)/86400000),gap2=Math.round((c.date-b.date)/86400000);
    if(gap1===gap2){const key=`gap-${gap1}-${c.ona}`;if(!byGap.has(key))byGap.set(key,{gap:gap1,ona:c.ona,start:c.date});}
    const h1=getHebrewDateParts(a.date),h2=getHebrewDateParts(b.date),h3=getHebrewDateParts(c.date);
    const d1=h1.day,d2=h2.day,d3=h3.day;
    if((d1===d2&&d2===d3)||((d2-d1+30)%30===1&&(d3-d2+30)%30===1)){
      const key=`heb-${d3}-${c.ona}-${h3.month}`;
      if(!byHebrew.has(key))byHebrew.set(key,{day:d3,ona:c.ona,start:c.date,increment:(d1===d2&&d2===d3)?0:1});
    }
  }
  return {byGap,byHebrew};
}
function getHebrewDateParts(d){
  const parts=new Intl.DateTimeFormat("he-u-ca-hebrew",{day:"numeric",month:"long"}).formatToParts(d);
  return {day:Number(parts.find(p=>p.type==="day")?.value||1),month:parts.find(p=>p.type==="month")?.value||""};
}
function hasKavuahForPeriod(period,kavuah){
  for(const v of kavuah.byGap.values()) if(v.ona===period.ona && period.date>=v.start) return true;
  for(const v of kavuah.byHebrew.values()) if(v.ona===period.ona && period.date>=v.start) return true;
  return false;
}
function recalcDerived(){
  clearDerived();
  const periods=[],hefseks=[];
  for(const [k,v] of dayEvents.entries()) for(const m of normalizeDay(v).markers){if(m.type==="period")periods.push({date:new Date(k),ona:m.ona||"day"}); if(m.type==="hefsek")hefseks.push(new Date(k));}
  periods.sort((a,b)=>a.date-b.date); hefseks.sort((a,b)=>a-b);
  const prefs=getPrefs();
  const day30Mode=prefs.day30Mode||"ona",day31Mode=prefs.day31Mode||"ona";
  const kavuah=calculateKavuah(periods);
  for(let i=0;i<periods.length;i++){
    const p=periods[i];
    const d30=addDays(p.date,29);
    if(!hasKavuahForPeriod(p,kavuah)){addPrishaMarkers(d30,getPrishaOnotForMode(p.ona,day30Mode),"×¢×•× ×” ×‘×™× ×•× ×™×ª","auto-30");}
    const ozDate=p.ona==="day"?d30:addDays(d30,-1); addMarker(ymd(ozDate),{type:"orzarua",label:markerLabel("××•×¨ ×–×¨×•×¢",p.ona==="day"?"night":"day"),ona:p.ona==="day"?"night":"day",source:"auto-oz"});
    if(prefs.day31){const d31=addDays(p.date,30);addPrishaMarkers(d31,getPrishaOnotForMode(p.ona,day31Mode),"×™×•× 31","auto-31");}
    const ready=addDays(p.date,minhagDays()-1); addMarker(ymd(ready),{type:"hefsekReady",label:"× ×™×ª×Ÿ ×œ×¢×©×•×ª ×”×¤×¡×§ ×˜×”×¨×”",source:"auto-ready"});
    const next=periods[i+1];
    if(next){
      const gap=Math.round((next.date-p.date)/86400000);
      if(gap>0){
        const haflagaDate=addDays(next.date,gap);
        addPrishaMarkers(haflagaDate,getPrishaOnotForMode(next.ona,day30Mode),`×”×¤×œ×’×” ${gap} ×™×•×`,`auto-haflaga-${gap}`);
      }
    }
  }
  for(const v of kavuah.byGap.values()){
    const d=addDays(v.start,v.gap);
    addMarker(ymd(d),{type:"prisha",label:markerLabel(`×•×¡×ª ×§×‘×•×¢ ${v.gap} ×™×•×`,v.ona),ona:v.ona,source:`auto-kavuah-gap-${v.gap}`});
  }
  for(const v of kavuah.byHebrew.values()){
    const d=addDays(v.start,29);
    addMarker(ymd(d),{type:"prisha",label:markerLabel("×•×¡×ª ×ª××¨×™×š ×§×‘×•×¢",v.ona),ona:v.ona,source:"auto-kavuah-heb"});
  }
  for(const h of hefseks){addMarker(ymd(addDays(h,7)),{type:"mikveh",label:"×˜×‘×™×œ×”",source:"auto-mikveh"});}
}
function getPhaseMap(y,m){
  const map={}; const first=new Date(y,m,1),start=addDays(first,-first.getDay());
  const periods=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="period").map(()=>new Date(k))).sort((a,b)=>a-b);
  const hefseks=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="hefsek").map(()=>new Date(k))).sort((a,b)=>a-b);
  const mikvehs=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="mikveh").map(()=>new Date(k))).sort((a,b)=>a-b);
  const hefsekReadys=[...dayEvents.entries()].flatMap(([k,v])=>normalizeDay(v).markers.filter(x=>x.type==="hefsekReady").map(()=>new Date(k))).sort((a,b)=>a-b);
  for(let i=0;i<42;i++){
    const d=addDays(start,i),key=ymd(d);
    const p=periods.filter(x=>x<=d).at(-1);
    const nextP=periods.find(x=>x>d);
    const h=hefseks.find(x=>p&&x>=p&&x<=d);
    const mk=mikvehs.find(x=>p&&x>=p&&x<=d);
    if(p&&!h){
      const hr=hefsekReadys.find(x=>x>=p&&x<=d);
      map[key]=hr?"wait":"period";
    }else if(h&&!mk){
      map[key]="wait";
    }else if(mk&&key===ymd(mk)){
      map[key]="mikveh";
    }else if(mk&&(!nextP||d<nextP)){
      map[key]="clean";
    }
  }
  for(const [k,v] of dayEvents.entries()) if(normalizeDay(v).markers.some(x=>x.type==="prisha")) map[k]="prisha";
  return map;
}

async function getCoordsWithRetry(){
  if(!webViewSafeReady) throw new Error("geo-not-ready");
  if(lastCoords) return lastCoords;
  if(locationPromise) return locationPromise;
  locationPromise=(async()=>{
    if(!navigator.geolocation) throw new Error("no-geo");
    let lastErr=null;
    for(let attempt=1;attempt<=4;attempt++){
      try{
        const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:9000,maximumAge:0}));
        lastCoords={latitude:pos.coords.latitude,longitude:pos.coords.longitude};
        return lastCoords;
      }catch(err){
        lastErr=err;
        await new Promise(r=>setTimeout(r,1200));
      }
    }
    throw lastErr||new Error("geo-failed");
  })();
  try{return await locationPromise;}finally{locationPromise=null;}
}

async function resolveSunset(date){
  const key=ymd(date);
  const prefs=getPrefs();
  const mode=prefs.sunsetMode||"location";
  const cityKey=prefs.sunsetCity||"Jerusalem";
  const cacheKey=mode==="city"?`city-${cityKey}-${key}`:`loc-${key}`;
  if(sunsetCache[cacheKey]) return sunsetCache[cacheKey];
  try{
    let coords;
    if(mode==="city") coords=CITY_COORDS[cityKey]||CITY_COORDS.Jerusalem;
    else coords=await getCoordsWithRetry();
    if(!webViewSafeReady){
      setTimeout(()=>renderTodayCard(),400);
      return "×˜×•×¢×Ÿ ××™×§×•×â€¦";
    }
    const url=`https://api.sunrise-sunset.org/json?lat=${coords.latitude}&lng=${coords.longitude}&date=${key}&formatted=0`;
    const r=await fetch(url); const j=await r.json();
    const t=new Date(j.results.sunset).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    sunsetCache[cacheKey]=t;
    if(mode==="city") saveSunsetCache();
    return t;
  }catch{
    sunsetCache[cacheKey]="×˜×•×¢×Ÿ ××™×§×•×â€¦";
    setTimeout(()=>{delete sunsetCache[cacheKey];renderTodayCard();},2500);
    return "×˜×•×¢×Ÿ ××™×§×•×â€¦";
  }
}


function hasMarkerOnDate(dateKey,type){return normalizeDay(dayEvents.get(dateKey)).markers.some(m=>m.type===type)}
function getReminderLog(){try{return JSON.parse(localStorage.getItem(REMINDER_FIRE_KEY)||"{}");}catch{return {};}}
function setReminderLog(next){localStorage.setItem(REMINDER_FIRE_KEY,JSON.stringify(next));}
async function ensureNotificationPermission(){
  if(window.AndroidBridge) return false;
  if(!("Notification" in window)) return false;
  if(Notification.permission==="granted") return true;
  if(Notification.permission==="denied") return false;
  const p=await Notification.requestPermission();
  return p==="granted";
}
function playReminderSound(){
  const Ctx=window.AudioContext||window.webkitAudioContext;
  if(!Ctx) return;
  const ctx=new Ctx();
  const osc=ctx.createOscillator(),gain=ctx.createGain();
  osc.type="sine"; osc.frequency.value=880; gain.gain.value=.001;
  osc.connect(gain); gain.connect(ctx.destination); osc.start();
  gain.gain.exponentialRampToValueAtTime(.28,ctx.currentTime+.03);
  gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.45);
  osc.stop(ctx.currentTime+.5);
}
async function fireHefsekReminder(dateKey){
  const log=getReminderLog();
  const time=getPrefs().reminderTime||"15:00";
  if(log[dateKey]===time) return;
  playReminderSound();
  const msg="×”×™×•× ×¦×¨×™×š ×œ×‘×¦×¢ ×”×¤×¡×§ ×˜×”×¨×”";
  const hasPermission=await ensureNotificationPermission();
  if(hasPermission && !window.AndroidBridge){
    new Notification("×ª×–×›×•×¨×ª ×œ×•×—",{body:msg,icon:"1.png"});
  }else{
    showToast(msg);
    alert(msg);
  }
  log[dateKey]=time;
  setReminderLog(log);
}
function startReminderWatcher(){
  if(reminderTimer) clearInterval(reminderTimer);
  const tick=async()=>{
    const prefs=getPrefs();
    if(!prefs.reminderEnabled) return;
    const dateKey=ymd(today);
    if(!hasMarkerOnDate(dateKey,"hefsek")) return;
    const now=new Date();
    const hhmm=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    if(hhmm>=(prefs.reminderTime||"15:00")) await fireHefsekReminder(dateKey);
  };
  tick();
  reminderTimer=setInterval(tick,30000);
}

async function renderTodayCard(){
  el("todayDate").textContent=`${new Intl.DateTimeFormat("he",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(today)} | ${getHebrewDateDisplay(today)}`;
  const sunset=await resolveSunset(today); const prefs=getPrefs(); el("todaySunset").textContent=`×©×§×™×¢×” ×œ×¤×™ ${prefs.sunsetMode==="city"?(CITY_COORDS[prefs.sunsetCity||"Jerusalem"]?.label||"×¢×™×¨"):"××™×§×•×"}: ${sunset}`;
  const dateKey=ymd(today);
  const chips=el("todayChips"); chips.innerHTML="";
  const todayMarkers=normalizeDay(dayEvents.get(dateKey)).markers;
  for(const m of todayMarkers){const c=document.createElement("span");c.className=`chip`;c.textContent=m.label;chips.appendChild(c)}
  const banner=el("todayBanner");
  const hefsekMarker=todayMarkers.find(m=>m.type==="hefsek");
  if(hefsekMarker){banner.textContent="âš ï¸ ×”×™×•× ×œ×‘×¦×¢ ×”×¤×¡×§ ×˜×”×¨×”";banner.title=hefsekMarker.note||"×œ×—×¦×™ ×œ×”×•×¡×¤×ª ×”×¢×¨×”";banner.onclick=()=>openMarkerNoteEditor(dateKey,hefsekMarker);banner.classList.remove("hidden");}
  else{banner.classList.add("hidden");banner.onclick=null;}
}
function startClock(){const paint=()=>el("clock").textContent=new Date().toLocaleTimeString("he-IL",{hour12:false});paint();if(clockTimer)clearInterval(clockTimer);clockTimer=setInterval(paint,1000)}

function renderContinuousMonths(){
  const track=el("continuousTrack");
  track.innerHTML="";
  const year=view.getFullYear();
  for(let m=0;m<12;m++){
    const d=new Date(year,m,1);
    const card=document.createElement("section");
    card.className="continuous-month";
    const title=document.createElement("div");
    title.className="continuous-month-title";
    title.textContent=new Intl.DateTimeFormat("he",{month:"long",year:"numeric"}).format(d);
    const monthGrid=document.createElement("div");
    monthGrid.className="grid";
    renderMonthCells(monthGrid,d.getFullYear(),d.getMonth());
    card.append(title,monthGrid);
    track.appendChild(card);
  }
}
function applyMode(){
  el("calendar").classList.toggle("hidden",continuousMode);
  el("continuousWrap").classList.toggle("active",continuousMode);
  el("toggleContinuous").classList.toggle("btn-toggle-active",continuousMode);
  if(continuousMode) renderContinuousMonths();
}

function getNoteHistory(){try{return JSON.parse(localStorage.getItem(NOTE_HISTORY_KEY)||"{}");}catch{return {};}}
function setNoteHistory(next){localStorage.setItem(NOTE_HISTORY_KEY,JSON.stringify(next));}
let activeNoteEditor=null;
function openMarkerNoteEditor(dateKey,marker){
  const day=normalizeDay(dayEvents.get(dateKey));
  const target=day.markers.find(m=>m.type===marker.type&&m.label===marker.label&&m.ona===marker.ona&&m.source===marker.source);
  if(!target) return;
  activeNoteEditor={dateKey,markerRef:target};
  el("noteTitle").textContent=`×”×¢×¨×” ×¢×‘×•×¨ ${target.label}`;
  el("noteSub").textContent=`×ª××¨×™×š: ${dateKey}`;
  el("noteInput").value=target.note||"";
  const key=`${dateKey}__${target.label}`;
  const history=getNoteHistory()[key]||[];
  const list=el("noteHistory");
  list.innerHTML=history.length?"":"<li>××™×Ÿ ×¢×“×™×™×Ÿ ×”×¢×¨×•×ª ×§×•×“××•×ª</li>";
  for(const item of history.slice().reverse()){
    const li=document.createElement("li");
    li.textContent=`${item.time} â€” ${item.text}`;
    list.appendChild(li);
  }
  el("noteOverlay").classList.remove("hidden");
}
function closeNoteEditor(){activeNoteEditor=null;el("noteOverlay").classList.add("hidden");}
async function saveNote(){
  if(!activeNoteEditor) return;
  const saveBtn=el("saveNoteBtn");
  if(saveBtn.disabled) return;
  saveBtn.disabled=true;
  saveBtn.textContent="×©×•××¨...";
  const {dateKey,markerRef}=activeNoteEditor;
  const text=(el("noteInput").value||"").trim();
  markerRef.note=text;
  if(!markerRef.note) delete markerRef.note;
  const hist=getNoteHistory();
  const key=`${dateKey}__${markerRef.label}`;
  const arr=hist[key]||[];
  if(text) arr.push({text,time:new Date().toLocaleString("he-IL")});
  hist[key]=arr.slice(-30);
  setNoteHistory(hist);
  closeNoteEditor();
  await commitAndSync();
  saveBtn.disabled=false;
  saveBtn.textContent="×©××•×¨";
}
async function clearNote(){
  if(!activeNoteEditor) return;
  const {markerRef}=activeNoteEditor;
  delete markerRef.note;
  await commitAndSync();
  closeNoteEditor();
}

function renderMonthCells(targetGrid,y,m){
  targetGrid.innerHTML="";
  const first=new Date(y,m,1),gridStart=addDays(first,-first.getDay()); const phaseMap=getPhaseMap(y,m);
  for(let i=0;i<42;i++){
    const d=addDays(gridStart,i),key=ymd(d),inMonth=d.getMonth()===m; const cell=document.createElement("div");
    const phase=phaseMap[key]; cell.className=`cell${inMonth?"":" muted"}${key===ymd(today)?" today":""}${phase?` phase-${phase}`:""}`;
    const greg=document.createElement("div");greg.className="greg";greg.textContent=d.getDate();
    const heb=document.createElement("div");heb.className="hebrew";heb.textContent=getHebrewDateDisplay(d);
    const sunset=document.createElement("div");sunset.className="sunset";sunset.textContent=`×©×§×™×¢×”: â€¦`; resolveSunset(d).then(t=>sunset.textContent=`×©×§×™×¢×”: ${t}`);
    cell.append(greg,heb,sunset);
    const markers=normalizeDay(dayEvents.get(key)).markers;
    const shouldShowHalves=markers.some(ev=>ev.ona||ev.type==="mikveh");
    let halfNight,halfDay;
    if(shouldShowHalves){
      const halves=document.createElement("div");halves.className="day-halves";
      halfNight=document.createElement("div");halfNight.className="half half-night half-empty";halfNight.innerHTML="ğŸŒ™";
      halfDay=document.createElement("div");halfDay.className="half half-day half-empty";halfDay.innerHTML="â˜€ï¸";
      halves.append(halfNight,halfDay);
      cell.insertBefore(halves,sunset);
    }
    for(const ev of markers){const b=document.createElement("div");b.className=`badge ${ev.type}`;b.textContent=ev.label;if(ev.note){const dot=document.createElement("span");dot.className="badge-note-dot";b.appendChild(dot);}b.title=ev.note||"×œ×—×¦×™ ×œ×”×•×¡×¤×ª ×”×¢×¨×”";b.onclick=(e)=>{e.stopPropagation();openMarkerNoteEditor(key,ev)};cell.appendChild(b);if(!shouldShowHalves)continue;if(ev.ona==="night"){halfNight.classList.remove("half-empty");halfNight.innerHTML=`ğŸŒ™ ${ev.label}`;}if(ev.ona==="day"){halfDay.classList.remove("half-empty");halfDay.innerHTML=`â˜€ï¸ ${ev.label}`;}if(!ev.ona&&ev.type==="prisha"){halfNight.classList.remove("half-empty");halfDay.classList.remove("half-empty");halfNight.innerHTML=`ğŸŒ™ ${ev.label}`;halfDay.innerHTML=`â˜€ï¸ ${ev.label}`;}if(ev.type==="mikveh"){halfNight.classList.remove("half-empty");halfNight.classList.add("mikveh-night");halfNight.innerHTML="ğŸŒ™ ×œ×™×œ×” ×˜×‘×™×œ×”";}}
    cell.onclick=()=>openModal(d); targetGrid.appendChild(cell);
  }
}

async function render(){
  const y=view.getFullYear(),m=view.getMonth();
  monthTitle.textContent=continuousMode?`×©× ×” ${y} â€” ×’×œ×™×œ×” ×¨×¦×™×¤×”` : new Intl.DateTimeFormat("he",{month:"long",year:"numeric"}).format(new Date(y,m,1));
  renderMonthCells(grid,y,m);
  await renderTodayCard();
}

function renderTimelineList(){
  const list=el("timelineList");
  const filter=el("timelineFilter")?.value||"all";
  list.innerHTML="";
  const items=[];
  for(const [dateKey,val] of dayEvents.entries()) for(const m of normalizeDay(val).markers){
    items.push({dateKey,label:m.label,type:m.type,note:m.note||""});
  }
  const filtered=items.filter(it=>filter==="all"?true:it.type===filter);
  filtered.sort((a,b)=>a.dateKey<b.dateKey?1:-1);
  if(!filtered.length){list.innerHTML='<div class="timeline-item">××™×Ÿ ×¢×“×™×™×Ÿ ××™×¨×•×¢×™× ×œ×¡×™× ×•×Ÿ ×©× ×‘×—×¨</div>';return;}
  for(const it of filtered){
    const row=document.createElement("div");
    row.className="timeline-item";
    row.innerHTML=`<strong>${it.label}</strong><small>${it.dateKey}</small>${it.note?`<small>×”×¢×¨×”: ${it.note}</small>`:""}`;
    list.appendChild(row);
  }
}
function openTimeline(){
  renderTimelineList();
  el("timelineOverlay").classList.remove("hidden");
}
const closeTimeline=()=>el("timelineOverlay").classList.add("hidden");

function openModal(d){el("modalDateTitle").textContent=`×ª××¨×™×š: ${ymd(d)}`;el("modalDateSub").textContent=`×¢×‘×¨×™: ${getHebrewDateDisplay(d)}`;el("modalOverlay").classList.remove("hidden");
  el("btnEventA").onclick=async()=>{if(!canSetHefsek(d)){alert(`××¤×©×¨ ×œ×¡××Ÿ ×”×¤×¡×§ ×˜×”×¨×” ××”×™×•× ×”-${minhagDays()} ××ª×—×™×œ×ª ×”××—×–×•×¨.`);return;}closeModal();addMarker(ymd(d),{type:"hefsek",label:"×”×¤×¡×§ ×˜×”×¨×”"},{replaceType:true});recalcDerived();await commitAndSync();};
  el("btnEventB").onclick=()=>openOnaPicker(d);
  el("btnClear").onclick=async()=>{closeModal();dayEvents.delete(ymd(d));recalcDerived();await commitAndSync();};
}
const closeModal=()=>el("modalOverlay").classList.add("hidden");
function openOnaPicker(date){el("onaOverlay").classList.remove("hidden");const apply=async ona=>{el("onaOverlay").classList.add("hidden");closeModal();addMarker(ymd(date),{type:"period",label:markerLabel("×ª×—×™×œ×ª ××—×–×•×¨",ona),ona},{replaceType:true});recalcDerived();await commitAndSync();};el("chooseDay").onclick=()=>apply("day");el("chooseNight").onclick=()=>apply("night")}

async function commitAndSync(){await persistAll();await render();showToast("×”× ×ª×•× ×™× ×¢×•×“×›× ×•")}

function openAuth(){el("authOverlay").classList.remove("hidden")} function closeAuth(){el("authOverlay").classList.add("hidden")}
function renderAuthMode(){const t=el("authTitle"),s=el("authSub"),sw=el("authSwitchText"),a=el("authActionBtn");if(authMode==="signin"){t.textContent="×”×ª×—×‘×¨×•×ª";s.textContent="×”×ª×—×‘×¨×™ ×¢× ××™××™×™×œ ×•×¡×™×¡××”";a.textContent="×”×ª×—×‘×¨×•×ª";sw.textContent="××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?";}else{t.textContent="×¨×™×©×•×";s.textContent="×¦×¨×™ ×—×©×‘×•×Ÿ ×—×“×©";a.textContent="×¨×™×©×•×";sw.textContent="×™×© ×œ×š ×›×‘×¨ ×—×©×‘×•×Ÿ?";}}
async function doSignIn(){try{await auth.signInWithEmailAndPassword(el("email").value,el("password").value);closeAuth();}catch(e){el("authMsg").textContent="×©×’×™××ª ×”×ª×—×‘×¨×•×ª: "+e.message}}
async function doSignUp(){try{await auth.createUserWithEmailAndPassword(el("email").value,el("password").value);closeAuth();}catch(e){el("authMsg").textContent="×©×’×™××ª ×¨×™×©×•×: "+e.message}}

auth.onAuthStateChanged(async user=>{currentUid=user?.uid||null;authState.textContent=user?`××—×•×‘×¨: ${user.email}`:"×œ× ××—×•×‘×¨";if(user){await loadRemoteEvents(user.uid);await persistAll();}recalcDerived();await render();});

el("prevMonth").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()-1,1);render()};
el("nextMonth").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()+1,1);render()};
el("todayPanel").onclick=()=>openModal(today);
el("toggleContinuous").onclick=()=>{continuousMode=!continuousMode;applyMode();render();};
el("modalClose").onclick=closeModal; el("modalOverlay").onclick=e=>{if(e.target===el("modalOverlay"))closeModal()};
el("onaCancel").onclick=()=>el("onaOverlay").classList.add("hidden"); el("onaOverlay").onclick=e=>{if(e.target===el("onaOverlay"))el("onaOverlay").classList.add("hidden")};
el("openTimeline").onclick=openTimeline; el("timelineClose").onclick=closeTimeline; el("timelineOverlay").onclick=e=>{if(e.target===el("timelineOverlay"))closeTimeline()};
el("timelineFilter").onchange=renderTimelineList;
el("noteClose").onclick=closeNoteEditor; el("cancelNoteBtn").onclick=closeNoteEditor; el("saveNoteBtn").onclick=saveNote; el("deleteNoteBtn").onclick=clearNote; el("noteOverlay").onclick=e=>{if(e.target===el("noteOverlay"))closeNoteEditor()};
const openDrawer=()=>{el("drawer").classList.remove("hidden");el("drawerBackdrop").classList.remove("hidden")}; const closeDrawer=()=>{el("drawer").classList.add("hidden");el("drawerBackdrop").classList.add("hidden")};
el("menuBtn").onclick=openDrawer; el("closeDrawer").onclick=closeDrawer; el("drawerBackdrop").onclick=closeDrawer;
el("openAuthFromMenu").onclick=()=>{openAuth();closeDrawer()}; el("authClose").onclick=closeAuth;

const darkToggle=el("darkToggle"),day31Toggle=el("day31Toggle"),day30Mode=el("day30Mode"),day31Mode=el("day31Mode"),minhagSelect=el("minhagSelect"),reminderToggle=el("reminderToggle"),meetingToggle=el("meetingToggle"),reminderTime=el("reminderTime"),sunsetMode=el("sunsetMode"),sunsetCity=el("sunsetCity");
const prefs=getPrefs(); darkToggle.checked=!!prefs.dark; day31Toggle.checked=!!prefs.day31; day30Mode.value=prefs.day30Mode||"ona"; day31Mode.value=prefs.day31Mode||"ona"; minhagSelect.value=prefs.minhag||"sephardi"; reminderToggle.checked=!!prefs.reminderEnabled; meetingToggle.checked=!!prefs.meetingReminders; reminderTime.value=prefs.reminderTime||"15:00"; sunsetMode.value=prefs.sunsetMode||"location"; sunsetCity.value=prefs.sunsetCity||"Jerusalem"; if(prefs.dark)document.body.classList.add("dark");
darkToggle.onchange=e=>{document.body.classList.toggle("dark",e.target.checked);setPrefs({dark:e.target.checked})};
day31Toggle.onchange=async e=>{setPrefs({day31:e.target.checked});recalcDerived();await commitAndSync()};
day30Mode.onchange=async e=>{setPrefs({day30Mode:e.target.value});recalcDerived();await commitAndSync()};
day31Mode.onchange=async e=>{setPrefs({day31Mode:e.target.value});recalcDerived();await commitAndSync()};
minhagSelect.onchange=async e=>{setPrefs({minhag:e.target.value});recalcDerived();await commitAndSync()};
reminderToggle.onchange=async e=>{setPrefs({reminderEnabled:e.target.checked});if(e.target.checked)await ensureNotificationPermission();startReminderWatcher();showToast("×”×ª×–×›×•×¨×ª ×¢×•×“×›× ×”")};
meetingToggle.onchange=e=>{setPrefs({meetingReminders:e.target.checked});showToast("×ª×–×›×•×¨×ª ×™××™ ×¤×¨×™×©×” ×¢×•×“×›× ×”")};
reminderTime.onchange=e=>{setPrefs({reminderTime:e.target.value||"15:00"});startReminderWatcher();showToast("×©×¢×ª ×”×ª×–×›×•×¨×ª ×¢×•×“×›× ×”")};
sunsetMode.onchange=async e=>{setPrefs({sunsetMode:e.target.value});await render();};
sunsetCity.onchange=async e=>{setPrefs({sunsetCity:e.target.value});await render();};

el("authActionBtn").onclick=()=>authMode==="signin"?doSignIn():doSignUp();
el("authSwitchBtn").onclick=e=>{e.preventDefault();authMode=authMode==="signin"?"signup":"signin";renderAuthMode()};
el("signOutBtn").onclick=async()=>{await auth.signOut();el("authMsg").textContent="×”×ª× ×ª×§×ª"};

applyMode(); startClock(); renderAuthMode(); if(!localStorage.getItem(AUTH_PROMPT_KEY)){openAuth();localStorage.setItem(AUTH_PROMPT_KEY,"1")} recalcDerived(); startReminderWatcher(); render();
window.addEventListener("load",()=>{
  setTimeout(()=>{
    webViewSafeReady=true;
    renderTodayCard();
  },500);
  setTimeout(()=>{
    renderTodayCard();
  },300);
});
</script>
</body>
</html>
